<!DOCTYPE html>
<meta name="viewport" content="width=device-width">
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>English Dictionary</title>
    <link rel="stylesheet" href="index.css">
</head>

<body onload="reqTopics()">
    <table align="center" width='100%' border=1>
        <tr>
            <th width="50px"  id="cap_">Subjects:</th>
            <td width="30%" align="left">
                <select id="Topics" name="Topics" title="TTT" onchange="onTopicChange(event)" style="width:100%">
                </select>
            </td>
            <td style="width:20%"  >
                <video controls="" autoplay="" name="media" id="mediaplayer" src="" type="audio/mpeg" width="100%"
                    height="20""></video>
            </td>
            <td style="width:10%" >
                <input type='checkbox' id='idEnCheckbox' name="group2" checked  onchange="onCbChange(event)" > English</input>
            </td>0
            <td  style="width:10%" >
                <input type='checkbox' id='idRuCheckbox' name="group2" checked onchange="onCbChange(event)" >Russian</input>
            </td>
        </tr>
    </table>

    <!--Response Table-->
    <table width='100%' height='100%' border=0>
        <tr>
            <td width=100% height='100%'>
                Response:
                <iframe title="frame" id=rsp name="rsp" style="width:100%; height:800px;" ></iframe>
            </td>
        </tr>
    </table>

    <script>

        function ajaxShowResponse() {
            var frm = document.getElementById('rsp');
            var doc = frm.contentDocument;

            let json = JSON.parse(this.responseText);
            var dic = json.dic;

            if (json.Status == "HTML") {
                var html = dic;
                doc.write(html);
            }
            else if (json.Status == "SUBJECTS") {
                //Populate select options
                var Topics = document.getElementById("Topics");
                for (var i = 0; i < dic.length; i++) {
                    var ob = dic[i];
                    var newOption = document.createElement('option');
                    var optionText = document.createTextNode(ob);
                    newOption.appendChild(optionText);
                    Topics.appendChild(newOption);
                }
                //Request table of 
                reqTopic(Topics.value);
            }
            else {
                var reply = JSON.stringify(json, null, 3);
                doc.write(reply);
            }
            doc.close();

            if (json.Status == "HTML") {
                for (var i = 1; i < dic.length + 1; i++) {
                    var idEn = "E" + i;
                    const en = doc.getElementById(idEn);
                    if (en != null) {
                        en.addEventListener("dblclick", reqMP3File, false);
                        en.addEventListener("mousewheel", reqMP3SentenceFile, false);
                    }
                }
            }
        }

        function ajaxGet(url, data) {
            var bRuVisible = document.getElementById('idRuCheckbox').checked;
            var bEnVisible = document.getElementById('idEnCheckbox').checked;

            var filter = "&bRuVisible=" + bRuVisible + "&bEnVisible=" + bEnVisible;
            let data_filter = data + filter;
            var oReq = new XMLHttpRequest();
            oReq.addEventListener("load", ajaxShowResponse);
            oReq.open("GET", url + "?" + data_filter);
            oReq.send();
        
        }

        function reqTopics() {
            var args = "cmd=Read_all_topics";
            ajaxGet("/Subjects", args);
        }

        function reqTopic(topic) {
            var args = "cmd=Read_topic&topic=" + topic;
            ajaxGet("/Subjects", args);
        }

        function reqMP3File(e) {
            var file = e.target.innerText + ".mp3";
            Play(file);
        }
        
        function reqMP3SentenceFile(e){
            var file = e.target.innerText + "--.mp3";
            Play(file);
        }
        
        function Play(filename) {
            var media = document.getElementById('mediaplayer');
            var topic = document.getElementById('Topics').value;
            media.src = "/Subjects?cmd=Read_mp3_file&filename=" + filename;
            media.play();
        }

        function doPlay() {
            var en = document.getElementById('en').value;
            Play(en);
        }

        function onTopicChange(e) {
            var text = e.target.value;
            reqTopic(text);
        }

        function onCbChange(e){
            var text = e.target.checked;
            var topic = document.getElementById('Topics').value;
            reqTopic(topic)
        }
    </script>



</body>

</html>