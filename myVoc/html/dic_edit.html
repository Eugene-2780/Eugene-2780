<!DOCTYPE html>
<meta name="viewport" content="width=device-width">
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>English Dictionary Edit</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <p>Edit Record</p>
    <table align=center width='100%' border=4>
        <tr>
            <td><label for="en">English:</label></td>
            <td>
                <input size='55' type="text" value="" id="en" name="en" autocomplete="off" onchange="" />
                <input type="button" name="button" value="Clear" onclick="document.getElementById('en').value = ''" />
            </td>
            <td align='center'> <input style="width:140px;" type="submit" name="button" value="Read" onclick="doRead()" /></td>
        </tr>
        <tr>
            <td><label for="ru">Russian:</label></td>
            <td>
                <input size='55' type="text" value="" id="ru" name="ru" />
                <input type="button" name="button" value="Clear" onclick="document.getElementById('ru').value = ''" />
            </td>
            <td align='center'> <input style="width:140px;" type="submit" name="button" value="Update" onclick="doEdit()" /> </td>
        </tr>
        <tr>
            <td><label for="cat">Category:</label></td>
            <td>
                <input list="Categories" size='55' id="cat" name="cat" value="Emotions">
                <datalist id="Categories">
                    <option value="Emotions">
                    <option value="Trait">
                    <option value="Expression">
                    <option value="Business">
                    <option value="House">
                    <option value="Money">
                    <option value="Clothes">
                    <option value="Shopping">
                    <option value="Food">
                    <option value="Driving">
                    <option value="Transportation">
                    <option value="Health">
                    <option value="Work">
                    <option value="Study">
                    <option value="Phone">
                    <option value="Sport">
                    <option value="Politics">
                    <option value="Crime">
                    <option value="Travel">
                    <option value="Weather">
                    <option value="Greeting">
                    <option value="Other">
                </datalist>
                <input type="button" name="button" value="Clear" onclick="document.getElementById('cat').value = ''" /></td>
            </td>
            <td align='center'> <input style="width:140px;" type="submit" name="button" value="Add" onclick="doAdd()" /> </td>
        </tr>
    </table>
        <!--Response Table-->
        <table width='100%' height='500' border=1>
            <tr>
                <td>
                    <p align='left'>Response:</p>
                    <iframe title="frame" id=rsp name="rsp" width=100% height='600' ></iframe>
                </td>
            </tr>
        </table>

        <script>
            function HTMLBegin() {
                var html = "<HTML>\n<BODY>\n<TABLE style=\"width:100%\" border=1 >\n";

                var th =
                    "<tr>" +
                    "<th>Index</th>" +
                    "<th>English <input type='checkbox' value=''> </th>" +
                    "<th>Russian <input type='checkbox' value=''> </th>" +
                    "<th>Categoty</th>" +
                    "</tr>";
                html = html.concat(th);
                return html;
            }

            function HTMLAddRow(rec, nIndex) {
                var row = "<tr  id=\"" + 'ROW' + nIndex + "\" >";
                var td = "<td><input type='radio' id='RADIO" + nIndex + "' name='group' value='" + nIndex + "' >" + nIndex + "</td>";
                row = row.concat(td);
                // td = "<td id=\"" + 'E' + nIndex + "\" >" + rec.en + "<audio autoplay> <source src='./data/" + rec.en + ".mp3\'" + "type='audio/mpeg' /></audio>" + 
                //     "<a href='./data/" + rec.en + ".mp3' > DL </a>" + "</td>";

                td = "<td id=\"" + 'E' + nIndex + "\" >" + rec.en + "</td>";
                row = row.concat(td);
                td = "<td id=\"" + 'R' + nIndex + "\" >" + rec.ru + "</td>";
                row = row.concat(td);
                td = "<td>" + rec.cat + "</td>";
                row = row.concat(td);
                row = row.concat("</tr>");
                return row;
            }

            function HTMLEnd() {
                return ("\n</TABLE>\n</BODY>\n</HTML>");
            }

            //Convert to html grid
            function ConvertToHTML(result) {
                var html = HTMLBegin();
                var nIndex = 1;
                for (var j = 0; j < result.length; j++) {
                    var rec = result[j];
                    var row = HTMLAddRow(rec, nIndex);
                    html = html.concat(row);
                    nIndex++;
                }
                html = html.concat(HTMLEnd());
                return html;
            }

            function doRadio(e) {
                var target = e.target || e.srcElement;
                var tableRow = target.parentElement.parentElement;
                var itemEn = tableRow.children.item(1).innerText;
                var itemRu = tableRow.children.item(2).innerText;
                var itemCa = tableRow.children.item(3).innerText;

                document.getElementById('en').value = itemEn;
                document.getElementById('ru').value = itemRu;
                document.getElementById('cat').value = itemCa;
            }

            function ajaxShowResponse() {
                var frm = document.getElementById('rsp');
                var doc = frm.contentDocument;

                let json = JSON.parse(this.responseText);
                var dic = json.dic;
                if(json.Status == "OK"){
                    var html = ConvertToHTML(dic);
                    doc.write(html);
                }
                else{
                    var reply = JSON.stringify(json, null, 3);
                    doc.write(reply);
                }
                doc.close();

                for (var i = 1; i < dic.length + 1; i++) {
                    var idRow = "ROW" + i;
                    var idRadio = "RADIO" + i;

                    const radio = doc.getElementById(idRadio);
                    if (radio != null) {
                        radio.addEventListener("change", doRadio, false);
                    }
                }
            }

            function ajaxPost(url, d) {
                var oReq = new XMLHttpRequest();
                oReq.addEventListener("load", ajaxShowResponse);
                oReq.open("POST", url);
                oReq.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                oReq.send(d);
            }

            function readReq(cmd) {
                var en = document.getElementById('en').value;
                var ru = document.getElementById('ru').value;
                var cat = document.getElementById('cat').value;

                var body = { "button": "Read", "en": "","ru":"", "cat":""  };
                body.button = cmd;
                body.en = en;
                body.ru = ru;
                body.cat = cat;
                var body = JSON.stringify(body);
                return body
            }

            function doRead() {
                var body = readReq("Read");
                ajaxPost("/dic_edit", body);
            }

            function doEdit() {
                var body = readReq("Edit");
                ajaxPost("/dic_edit", body);
            }
            function doAdd() {
                var body = readReq("Add");
                ajaxPost("/dic_edit", body);
            }

        </script>



</body>

</html>